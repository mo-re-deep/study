# 11장 Next.js 13과 리액트 18

- Next.js 버전 13은 가장 큰 변화가 있는 릴리스
- 서버 사이드 렌더링의 구조에 많은 변화가 있는 리액트 18 채택
- 기존에 Next.js의 큰 약점으로 지적되던 레이아웃 지원을 본격적으로 지원하기 시작
- 바벨을 대체할 러스트(Rust) 기반 SWC를 뒤이어 웹팩을 대체할 Turbopack까지 출시

# 11.1 app 디렉터리의 등장

- 공통 헤더와 사이드 바가 대부분의 페이지에 필요한 웹사이트를 개발한다고 가정
- react-router-dom을 사용한다면
    - <Routes>의 외부 영역은 주소가 바뀌더라도 공통 영역으로 남을 것이며, <Routes> 내부만 주소에 맞게 변경될 것이다.
    - 사용하기에 따라서 <Routes>의 외부 영역 같이 해당 주소의 또 다른 영역을 공통으로 꾸미는 등의 작업이 가능하다.
- Next.js에서 이런 구조를 유지하려면
    - 13 버전 이전까지 모든 페이지는 각각의 물리적으로 구별된 파일로 독립돼 있었다.
    - 페이지 공통으로 무언가를 집어 넣을 수 있는 곳은 _document와 _app이 유일하다.
        - *document: 페이지에서 쓰이는 <html>과 <body> 태그를 수정하거나, 서버 사이드 렌더링 시 styled-components 같은 일부 CSS-in-JS 를 지원하기 위한 코드를 삽입하는 제한적인 용도로 사용된다. 오직 서버에서만 작동하므로 onClick같이 이벤트 핸들러를 붙이거나 클라이언트 로직을 붙이는 것을 금지하고 있다.*
        - _app: _app은 페이지를 초기화하기 위한 용도로 사용되며, 다음과 같은 작업이 가능하다고 명시돼 있다.
            - 페이지 변경 시에 유지하고 싶은 레이아웃
            - 페이지 변경 시 상태 유지
            - componentDidCatch를 활용한 에러 핸들링
            - 페이지간 추가적인 데이터 삽입
            - global CSS 주입
- 레이아웃의 한계를 극복하기 위해 나온 것이 Next.js의 app 레이아웃이다.

## 11.1.1 라우팅

- 기존에 /pages로 정의하던 라우팅 방식이 /app 디렉터리로 이동했다.
- 파일명으로 라우팅하는 것이 불가능해졌다.

### 라우팅을 정의하는 법

- app 기반 라우팅 시스템은 기존에 /pages를 사용했던 것과 비슷하지만 다음과 같은 약간의 차이가 있다.
    - Next.js 12 이하: /pages/a/b.tsx 또는 /pages/a/b/index.tsx는 모두 동일한 주소로 변환된다. 즉, 파일명이 index라면 이 내용은 무시된다.
    - Next.js 13 app: /app/a/b는 /a/b로 변환되며, 파일명은 무시된다. 폴더명까지만 주소로 변환된다.
- 즉, Next.js 13의 app 디렉터리 내부의 파일명은 라우팅 명칭에 아무런 영향을 미치지 못한다.

### layout.js

- Next.js 13부터는 app 디렉터리 내부의 폴더명이 라우팅이 되며, 이 폴더에 포함될 수 있는 파일명은 몇 가지로 제한돼 있다.
- 그중 하나가 layout.js이다.
    - 이 파일은 페이지의 기본적인 레이아웃을 구성하는 요소다.
    - 해당 폴더에 layout이 있다면 그 하위 폴더 및 주소에 모두 영향을 미친다.
    - 루트에는 단 하나의 layout을 만들어 둘 수 있다. 이 layout은 모든 페이지에 영향을 미치는 공통 레이아웃이다.
    - 꼭 공통 레이아웃이 필요하진 않더라도 웹페이지에 필요한 기본 정보만 담아둬도 추분히 유용하다.
    - 페이지 하위에 추가되는 layout은 해당 주소 하위에만 적용된다.
- layout은 주소별 공통 UI를 포함할 수 있을뿐만 아니라 _app과 _document를 대신해 웹페이지를 시작하는 데 필요한 공통 코드를 삽입할 수도 있다.
- layout.js의 또 다른 장점은 _document.jsx에서만 처리할 수 있었던 부자연스러움이 사라졌다는 것이다.
    - 기존에는 애플리케이션의 <html/>이나 <body/>에 무언가 스타일을 추가하는 등의 작업을 하려면 _document.jsx를 사용해야 했을뿐만 아니라 Next.js에서 제공하는 태그를 사용해야만 했다.
    - 그러나 이제 HTML에서 기본으로 제공하는 태그를 추가하고 수정함으로써 별도로 import하는 번거로움이 사라지고 좀 더 자연스럽게 코드를 작성할 수있게 됐다.
- layout에서 주의해야 할 점
    - layout은 app 디렉터리 내붸서는 예약어다. 무조건 layout.{js|jsx|ts|tsx}로 사용해야 하며, 레이아웃 이외의 다른 목적으로는 사용할 수 없다.
    - layout은 children을 props로 받아서 렌더링해야 한다. 레이아웃이므로 당연히 그려야 할 컴포넌트를 외부에서 주입받고 그려야 한다.
    - layout 내부에는 반드시 export default로 내보내는 컴포넌트가 있어야 한다.
    - layout 내부에서도 API 요청과 같은 비동기 작업을 수행할 수 있다.

### page.js

- layout과 마찬가지로 page도 예약어이며, 이전까지 Next.js에서 일반적으로 다뤘던 페이지를 의미한다.
- 다음과 같이 구성돼 있는 page는 앞에서 구성했던 layout을 기반으로 리액트 컴포넌트를 노출하게 된다.

```jsx
export default function BlogPage() {
  return <>여기에 블로그 글</>
}
```

- 이 page가 받는 props는 다음과 같다.
    - params: 옵셔널 값으로, 앞서 설명한 […id]와 같은 동적 라우트 파라미터를 사용할 경우 해당 파라미터에 값이 들어온다.
    - searchParams: URL에서 ?a=1과 같은 URLSearchParams를 의마한다. 예를 들어 ?a=1&b=2로 접근할 경우 searchParams에는 { a: ‘1’, b: ‘2’ }라는 자바스크립트 객체 값이 오게 된다. 한 가지 주목해야 할 것은 이 값은 layout에서는 제공되지 않는다는 것이다. 그 이유는 layout은 페이지 탐색 중에는 리렌더링을 수해하지 않기 때문이다. 즉, 같은 페이지에서 search parameter만 다르게 라우팅을 시도하는 경우 layout을 리렌더링하는 것은 불필요하기 때문이다. 만약 search parameter에 의존적인 작업을 해야 한다면 반드시 page 내부에서 수행해야 한다.
- page는 다음과 같은 규칙을 가지고 있다.
    - page도 역시 app 디렉터리 내부의 예약어이다. 무조건 page.{js|jsx|ts|tsx}로 사용해야 하며, 레이아웃 이외의 다른 목적으로는 사용할 수 없다.
    - page도 역시 내부에서 반드시 export default로 내보내는 컴포넌트가 있어야 한다.

### error.js

- 해당 라우팅 영역에서 사용되는 공통 에러 컴포넌트다.
- error.js를 사용하면 특정 라우팅별로 서로 다른 에러 UI를 렌더링하는 것이 가능해진다.
- error 페이지는 에러 정보를 담고 있는 error: Error 객체와 에러 바운더리를 초기화할 reset: () ⇒ void를 props로 받는다.
- 에러 바운더리는 클라이언트에서만 작동하므로 error 컴포넌트도 클라이언트 컴포넌트여야 한다.
- error 컴포넌트는 같은 수준의 layout에서 에러가 발생할 경우 해당 error 컴포넌트로 이동하지 않는다.
    - 만약 layout에서 발생한 에러를 처리하고 싶다면 상위 컴포넌트의 error를 사용하거나, app의 루트 에러 처리를 담당하는 app/global-error.js 페이지를 생성하면 된다.

### not-found.js

- 특정 라우팅 하위의 주소를 찾을 수 없는 404 페이지를 렌더링할 때 사용된다.

### loading.js

- 뒤이어 설명할 Supense를 기반으로 해당 컴포넌트가 불러오는 중임을 나타낼 때 사용할 수 있다.
- “use client” 지시자를 사용해 클라이언트에서 렌더링되게 할 수도 있다.

### route.js

- Next.js 13.4.0에서 app 디렉터리가 정식으로 출시되면서 이전까지 지원하지 못했던 /pages/api에 대한 /app 디렉터리 내부의 지원도 추가됐다.
- /pages/api와 동일하게 /app/api를 기준으로 디렉터리 라우팅을 지원하며, /api에 대해서도 파일명 라우팅이 없어지는 대신 디렉터리가 라우팅 주소를 담당하며 파일명은 route.js로 통일됐다.
- route.js 파일 내부에 REST API의 get, post와 같은 메서드명을 예약어로 선언해 두면 HTTP 요청에 맞게 해당 메서드를 호출하는 방식으로 작동한다.
- app/api 외에 다른 곳에서 선언해도 작동한다.
- 라우팅 명칭에 자유도가 생긴 대신, route.ts가 존재하는 폴더 내부에는 page.tsx가 존재할 수 없다. 만약 두 파일이 공존한다면 경고 메시지를 보게 된다.
- route의 함수들이 받을 수 있는 파라미터는 다음과 같다.
    - request: NextRequest 객체이며, fetch의 Request를 확장한 Next.js만의 Request라고 보면 된다. 이 객체에는 API 요청과 관련된 cookie, headers 등뿐만 아니라 nextUrl 같은 주소 객체도 확인할 수 있다.
    - context: params만을 가지고 있는 객체이며, 이 객체는 앞서 파일 기반 라우팅에서 언급한 것과동일한 동적 라우팅 파라미터 객체가 포함돼 있다. 이 객체는 Next.js에서 별도 인터페이스를 제공하지 않으므로 주소의 필요에 따라 원하는 형식으로 선언하면 된다.